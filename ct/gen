#!/bin/sh

set -e

# OS X prepends global symbols with _. 

if [[ $(uname) == 'Darwin' ]]; then
    find_cttest_symbols="cut -d ' ' -f 3 | egrep '^_cttest' | egrep -v '\.eh\$' | sed 's/^_//'"
else
    find_cttest_symbols="cut -d ' ' -f 3 | egrep '^cttest'"
fi

tests() {
    for f in "$@"
    do
        nm $f
    done | eval $find_cttest_symbols
}

ts=`tests "$@" || (echo >&2 no tests found; exit 1)`

gen() {
    printf '#include "internal.h"\n'
    printf '\n'

    i=0
    for t in "$@"
    do
        printf 'extern void %s(void);\n' $t
        i=`expr $i + 1`
    done

    printf '\nint\nmain(int argc, char *argv[])\n{\n'

    printf '    T ts[%d] = {};\n' $i

    i=0
    for t in "$@"
    do
        printf '    ctrun(&ts[%d], %d, %s, "%s");\n' $i $i $t $t
        i=`expr $i + 1`
    done

    printf '    ctreport(ts, %d);\n' $i
    printf '    return 0;\n'
    printf '}\n'
}

gen $ts #> _test.c
#rm -f _test.o
#cc -o _test.o _test.c
